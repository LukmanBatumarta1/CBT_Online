<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online - CBT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .exam-header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h2 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .header-left p {
            color: #666;
            font-size: 14px;
        }
        
        .timer-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 120px;
            text-align: center;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            font-family: monospace;
        }
        
        .warning-banner {
            background: #ffc107;
            color: #856404;
            padding: 10px;
            text-align: center;
            margin-top: 70px;
            display: none;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 100px auto 40px;
            padding: 0 20px;
        }
        
        .question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .question-number {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .question-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #333;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .options-grid {
            display: grid;
            gap: 15px;
        }
        
        .option-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .option-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .option-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .option-radio {
            margin-right: 15px;
            transform: scale(1.2);
        }
        
        .option-label {
            font-size: 16px;
            font-weight: 500;
        }
        
        .navigation-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        
        .nav-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }
        
        .nav-btn.next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .question-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .q-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .q-btn.answered {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .q-btn.current {
            background: #667eea;
            color: white;
        }
        
        .submit-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .btn-submit {
            padding: 15px 50px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }
        
        .question-info {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="exam-header">
        <div class="header-left">
            <h2 id="mapelName">Ujian Online</h2>
            <p id="userName">Siswa</p>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">90:00</div>
            <div style="font-size: 12px;">WAKTU TERSISA</div>
        </div>
    </div>
    
    <div class="warning-banner" id="warningBanner">
        ⚠️ PERINGATAN: Anda telah meninggalkan halaman ujian! Peringatan ke-<span id="warningCount">1</span>. Jika meninggalkan halaman sekali lagi, ujian akan diakhiri otomatis!
    </div>
    
    <div class="container">
        <div class="question-card">
            <div class="question-number" id="questionNumber">Soal 1 dari 10</div>
            <div class="question-text" id="questionText">Memuat soal...</div>
            
            <div class="options-grid" id="optionsContainer">
                <!-- Options will be loaded here -->
            </div>
            
            <div class="navigation-bar">
                <button class="nav-btn prev" onclick="prevQuestion()" id="prevBtn">← Sebelumnya</button>
                
                <div class="question-navigation" id="questionNavigation">
                    <!-- Question buttons will be loaded here -->
                </div>
                
                <button class="nav-btn next" onclick="nextQuestion()" id="nextBtn">Selanjutnya →</button>
            </div>
            
            <div class="question-info">
                <span id="answeredCount">0</span> dari <span id="totalQuestions">0</span> soal terjawab
            </div>
            
            <div class="submit-section">
                <button class="btn-submit" onclick="confirmSubmit()">
                    SELESAIKAN UJIAN
                </button>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">
                    Pastikan semua soal telah terjawab sebelum menyelesaikan ujian
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VARIABEL GLOBAL
        // ============================================
        let soalData = [];
        let currentQuestion = 0;
        let answers = {};
        let timeLeft = 90 * 60; // 90 menit dalam detik
        let warningCount = 0;
        let timerInterval;
        
        // ============================================
        // ANTI-CHEATING SYSTEM
        // ============================================
        
        // Deteksi pindah tab/browser
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                warningCount++;
                
                if (warningCount >= 2) {
                    // Jika sudah 2x warning, langsung submit
                    alert('❌ UJIAN DIHENTIKAN!\nAnda telah meninggalkan halaman ujian 2 kali.\nUjian diakhiri secara otomatis.');
                    submitUjian();
                } else {
                    // Tampilkan warning
                    const warningBanner = document.getElementById('warningBanner');
                    document.getElementById('warningCount').textContent = warningCount;
                    warningBanner.style.display = 'block';
                    
                    // Sembunyikan setelah 5 detik
                    setTimeout(() => {
                        warningBanner.style.display = 'none';
                    }, 5000);
                }
            }
        });
        
        // Blokir klik kanan
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Blokir shortcut keyboard tertentu
        document.addEventListener('keydown', function(e) {
            // Blokir: F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
                (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                return false;
            }
            
            // Shortcut navigasi soal
            if (e.keyCode === 37) { // Arrow left
                prevQuestion();
            } else if (e.keyCode === 39) { // Arrow right
                nextQuestion();
            } else if (e.keyCode >= 49 && e.keyCode <= 52) { // Numbers 1-4
                const optionIndex = e.keyCode - 49;
                selectOption(optionIndex);
            }
        });
        
        // ============================================
        // FUNGSI UTAMA
        // ============================================
        
        function loadQuestion(index) {
            if (!soalData[index]) return;
            
            const question = soalData[index];
            
            // Update nomor soal
            document.getElementById('questionNumber').textContent = 
                `Soal ${index + 1} dari ${soalData.length}`;
            
            // Update teks soal
            const questionText = document.getElementById('questionText');
            questionText.innerHTML = question.soal;
            
            // Tambahkan gambar jika ada
            if (question.gambar && question.gambar.trim() !== '') {
                const img = document.createElement('img');
                img.src = question.gambar;
                img.alt = 'Gambar soal';
                img.className = 'question-image';
                questionText.appendChild(img);
            }
            
            // Load pilihan jawaban
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            const options = [
                { id: 'A', text: question.pilihan_a },
                { id: 'B', text: question.pilihan_b },
                { id: 'C', text: question.pilihan_c },
                { id: 'D', text: question.pilihan_d }
            ];
            
            options.forEach((option, idx) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `option-item ${answers[question.id] === option.id ? 'selected' : ''}`;
                optionDiv.innerHTML = `
                    <input type="radio" class="option-radio" name="answer_${question.id}" 
                           value="${option.id}" 
                           ${answers[question.id] === option.id ? 'checked' : ''}
                           onchange="selectAnswer('${question.id}', '${option.id}')">
                    <span class="option-label">${option.id}. ${option.text}</span>
                `;
                optionDiv.onclick = function() {
                    selectAnswer(question.id, option.id);
                };
                optionsContainer.appendChild(optionDiv);
            });
            
            // Update navigasi soal
            updateQuestionNavigation();
            updateAnsweredCount();
            
            // Update tombol navigasi
            document.getElementById('prevBtn').style.display = index === 0 ? 'none' : 'block';
            document.getElementById('nextBtn').style.display = index === soalData.length - 1 ? 'none' : 'block';
            
            // Scroll ke atas
            window.scrollTo(0, 0);
        }
        
        function selectAnswer(questionId, answer) {
            answers[questionId] = answer;
            loadQuestion(currentQuestion);
        }
        
        function selectOption(index) {
            const options = ['A', 'B', 'C', 'D'];
            if (options[index] && soalData[currentQuestion]) {
                selectAnswer(soalData[currentQuestion].id, options[index]);
            }
        }
        
        function nextQuestion() {
            if (currentQuestion < soalData.length - 1) {
                currentQuestion++;
                loadQuestion(currentQuestion);
            }
        }
        
        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion(currentQuestion);
            }
        }
        
        function updateQuestionNavigation() {
            const navContainer = document.getElementById('questionNavigation');
            navContainer.innerHTML = '';
            
            soalData.forEach((question, index) => {
                const btn = document.createElement('button');
                btn.className = 'q-btn';
                btn.textContent = index + 1;
                
                if (answers[question.id]) {
                    btn.classList.add('answered');
                }
                if (index === currentQuestion) {
                    btn.classList.add('current');
                }
                
                btn.onclick = function() {
                    currentQuestion = index;
                    loadQuestion(index);
                };
                
                navContainer.appendChild(btn);
            });
        }
        
        function updateAnsweredCount() {
            const answered = Object.keys(answers).length;
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('totalQuestions').textContent = soalData.length;
        }
        
        // ============================================
        // TIMER SYSTEM
        // ============================================
        
        function startTimer() {
            // Update timer segera
            updateTimerDisplay();
            
            // Jalankan interval setiap detik
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                // Jika waktu habis
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('⏰ WAKTU UJIAN TELAH HABIS!\nUjian akan diselesaikan secara otomatis.');
                    submitUjian();
                }
                
                // Warning saat waktu hampir habis
                if (timeLeft === 300) { // 5 menit tersisa
                    alert('⏳ PERINGATAN: Waktu ujian tersisa 5 menit!');
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            const timerElement = document.getElementById('timer');
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Ubah warna saat waktu hampir habis
            if (timeLeft <= 300) { // 5 menit
                timerElement.style.color = '#dc3545';
            } else if (timeLeft <= 600) { // 10 menit
                timerElement.style.color = '#ffc107';
            }
        }
        
        // ============================================
        // SUBMIT SYSTEM
        // ============================================
        
        function confirmSubmit() {
            const answered = Object.keys(answers).length;
            const total = soalData.length;
            
            if (answered < total) {
                if (confirm(`Anda telah menjawab ${answered} dari ${total} soal.\nApakah Anda yakin ingin menyelesaikan ujian?`)) {
                    submitUjian();
                }
            } else {
                if (confirm(`Anda telah menjawab semua ${total} soal.\nApakah Anda yakin ingin menyelesaikan ujian?`)) {
                    submitUjian();
                }
            }
        }
        
        async function submitUjian() {
            // Hentikan timer
            clearInterval(timerInterval);
            
            // Hitung nilai
            const score = calculateScore();
            const waktuPengerjaan = ((90 * 60 - timeLeft) / 60).toFixed(2); // dalam menit
            
            // Ambil data user dan mapel
            const userData = JSON.parse(sessionStorage.getItem('userData'));
            const mapelData = JSON.parse(sessionStorage.getItem('mapelData'));
            
            if (!userData || !mapelData) {
                alert('Error: Data tidak ditemukan');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // Simpan hasil ke spreadsheet
                const result = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler().withFailureHandler()
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .saveHasilUjian(
                            userData.username,
                            userData.nama,
                            mapelData.id,
                            mapelData.nama_mapel,
                            score,
                            waktuPengerjaan
                        );
                });
                
                if (result.success) {
                    // Simpan data untuk halaman hasil
                    sessionStorage.setItem('nilai', score);
                    sessionStorage.setItem('waktuPengerjaan', waktuPengerjaan);
                    
                    // Redirect ke halaman hasil
                    window.location.href = 'hasil.html';
                } else {
                    alert('Error menyimpan hasil: ' + result.message);
                }
            } catch (error) {
                console.error('Error submit ujian:', error);
                alert('Terjadi kesalahan saat menyimpan hasil. Coba lagi.');
            }
        }
        
        function calculateScore() {
            let correct = 0;
            soalData.forEach(question => {
                if (answers[question.id] === question.jawaban_benar) {
                    correct++;
                }
            });
            
            // Hitung nilai dalam persen
            return (correct / soalData.length) * 100;
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = async function() {
            // Cek apakah user sudah login
            const userData = JSON.parse(sessionStorage.getItem('userData'));
            const mapelData = JSON.parse(sessionStorage.getItem('mapelData'));
            
            if (!userData || !mapelData) {
                alert('Anda belum login atau memilih mata pelajaran!');
                window.location.href = 'index.html';
                return;
            }
            
            // Update header
            document.getElementById('userName').textContent = userData.nama;
            document.getElementById('mapelName').textContent = mapelData.nama_mapel;
            
            // Set timer sesuai mapel
            timeLeft = (mapelData.waktu_menit || 90) * 60;
            
            try {
                // Load soal dari spreadsheet
                const soal = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler().withFailureHandler()
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getSoalByMapel(mapelData.id);
                });
                
                if (soal.length === 0) {
                    alert('Tidak ada soal untuk mata pelajaran ini!');
                    window.location.href = 'index.html';
                    return;
                }
                
                soalData = soal;
                loadQuestion(0);
                startTimer();
                
            } catch (error) {
                console.error('Error loading soal:', error);
                alert('Error memuat soal: ' + error);
            }
        };
    </script>
</body>
</html>